<!doctype html>
<html>
	<head>
		<link rel="icon" href="favicon.ico">
		<title>
			Journal
		</title>
		<base target="_self">
		<script src="preformatting.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.6.1/firebase.js"></script>
		<script src="https://www.gstatic.com/firebasejs/4.6.1/firebase-firestore.js"></script>
		<script src="https://epicenterprograms.github.io/standards/behavior/firebaseinit.js"></script>
		<script src="https://epicenterprograms.github.io/standards/behavior/general.js"></script>
		<script src="https://epicenterprograms.github.io/standards/behavior/storage.js"></script>
		<script src="loadpeople.js"></script>
		<script src="topics.js"></script>
		<script src="behavior.js"></script>
		<script>
			var session = Standards.storage.session;
			session.defaultLocation = "/journal/search/";
			var months = ["", "January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"];
			var pagesToCheck = ["entries/first.html"];



            function resetPage() {
                S.getId("heading").textContent = "Results:";
				S.getId("result").innerHTML = "";
				S.getId("entryDisplay").innerHTML = "";
			}

			S.listen("searchButton", "click", function () {
				if (S.getId("searchText").value.trim()) {
					let text = S.getId("searchText").value.trim();
					let query;
					if (text.search(/p.*\d+/) > -1) {
						query = "?p=" + text.match(/\d+/)[0];
					} else if (text.search(/t.*\d+/) > -1) {
						query = "?t=" + text.match(/\d+/)[0];
					} else {
						query = "?hint=" + encodeURIComponent(text);
					}
					window.location.href = query;
				}
			});

			S.listen("peopleLister", "click", function () {
				resetPage();
				S.forEach(people.slice(1), function (person, index) {
                    addListItem("p" + (index+1), '<a href="?p=' + (index + 1) + '">' + person.firstName + (person.lastName ? " " + person.lastName : "") + "</a>");
				});
            });
			S.listen("peopleLister", ["contextmenu", "touchhold"], function () {  // when trying to list people placeholders
				resetPage();
                S.forEach(placeholders.slice(1), function (person, index) {
                    addListItem("p0" + (index + 1), '<a href="?p=0' + (index + 1) + '">' + person.name + (person.lastName ? " " + person.lastName : "") + "</a>");
                });
			});

			S.listen("topicLister", "click", function () {
				resetPage();
				S.forEach(topics.slice(1), function (topic, index) {
                    addListItem("t" + (index + 1), '<a href="?t=' + (index + 1) + '">' + topic.title + "</a>");
				});
			});

            S.listen("pageTitle", ["contextmenu", "touchhold"], function () {  // when trying to include "snapshots.html" in pagesToCheck
				session.store("admin", true);
				window.location.reload();
            });

            function addListItem(heading, information) {
				let row = S.getId("result").insertRow(-1);
				if (heading.search(/: |<br>/) > -1) {  // if all of the information was bunched into the heading
					heading = heading.split(/: |<br>/);
					let label = document.createElement("th");
					label.innerHTML = heading[0] + ":";
					row.appendChild(label);
					let item = document.createElement("td");
					item.innerHTML = heading[1];
					row.appendChild(item);
                } else {
                    let label = document.createElement("th");
                    label.innerHTML = heading;
                    row.appendChild(label);
                    let item = document.createElement("td");
                    item.innerHTML = information;
                    row.appendChild(item);
				}
			}

			S.onLoad(function () {
				if (window.location.href.includes("?")) {
					window.addEventListener("loadedAllPeople", function () {
						if (session.recall("admin") === true) {
							pagesToCheck.push("snapshots.html");
							/// prevents ordinary people from seeing entries that aren't ready yet
						}

						let query = window.location.href.slice(window.location.href.indexOf("?") + 1).split("=");
						if (query[0] == "p") {
							let person;
							if (query[1][0] !== "0") {  // if it's not a person placeholder
								person = people[query[1]];
							} else {
								person = placeholders[query[1].slice(1)];
							}
							if (typeof person === "undefined" || person == {}) {
								S.getId("heading").textContent = "Error";
								S.getId("result").innerHTML = "This person doesn't exist.";
							} else {
                                S.getId("heading").textContent = person.firstName + (person.lastName ? " " + person.lastName : "");
								addListItem("Common name: " + person.name);
								if (person.pronunciation) {
									addListItem("Full name pronunciation: " + person.pronunciation);
								}
								if (person.hasOwnProperty("dateOfBirth")) {
									let date = person.dateOfBirth.split("/");
									if (date.length > 2) {  // if the year is listed
										addListItem("Date of birth: " + months[date[1]] + " " + date[2] + ", " + date[0]);
                                    } else {
                                        addListItem("Date of birth: " + months[date[0]] + " " + date[1]);
									}
								}
								addListItem("Numerical designation: " + query[1]);

								// shows which entries the person appears in
								let pagesToLoad = pagesToCheck.length;
								let journalPages = {};
								S.forEach(pagesToCheck, function (path) {
									S.getFile(path, function (content) {
										journalPages[path] = identifyPeople(reformatPersonNumbers(content), { loadPeople: false });
										pagesToLoad--;
										if (pagesToLoad == 0) {  // if all of the pages have loaded
                                            let entryList = [];
                                            // find all of the entries where the person appears
											S.forEach(journalPages, function (page, pagePath) {
												S.forEach(page.getElementsByClassName("p" + query[1]), function (occurrence) {
													let entry = findEntry(occurrence);
													if (entry && entryList.every(function (item) { return item.date != entry.dataset.date })) {
														let info = {};
														info.heading = entry.getElementsByTagName("h2")[0].textContent.trim();
														info.date = entry.dataset.date;
														info.url = pagePath + "#" + encodeURIComponent(info.heading);
														if (info.url.includes("snapshots")) {
															info.url += "?show=" + info.date;
														}
                                                        let beforeText = "";
                                                        let beforeNode = occurrence;
                                                        do {
                                                            if (beforeNode.previousSibling === null) {  // if the next sibling doesn't exist
                                                                beforeNode = beforeNode.parentElement;  // move to the parent
                                                                beforeText = " " + beforeText;
                                                            } else {
                                                                beforeNode = beforeNode.previousSibling;
																if (beforeNode.textContent.trim() != "") {  // if there's content in the node
																	if (beforeNode.nodeType == 1) {  // if the node is an element
																		if (["ASIDE", "H2"].includes(beforeNode.tagName)) {
																			// skip asides and headings
																			continue;
																		} else if (beforeNode.className.includes("entry")) {
																			// don't include anything outside of the entry
																			// also prevents adding "... " before the text
																			break;
																		}
																	}
                                                                    let match = beforeNode.textContent.match(/ ?(?:[^ ]+ ){0,25}[^ ]*$/);
                                                                    if (match !== null) {  // if words could be found
                                                                        beforeText = match[0] + beforeText;
                                                                    }
																	if (beforeText.length > 80) {  // if the snippet has gotten long enough
																		beforeText = "... " + beforeText;
                                                                        break;
                                                                    }
                                                                }
                                                            }
                                                        } while (beforeNode !== null);  // while there are still parent nodes
														let afterText = "";
														let afterNode = occurrence;
														do {
															if (afterNode.nextSibling === null) {  // if the next sibling doesn't exist
																afterNode = afterNode.parentElement;  // move to the parent
																afterText += " ";
                                                            } else {
                                                                afterNode = afterNode.nextSibling;
                                                                if (afterNode.textContent.trim() != "") {  // if there's content in the node
                                                                    if (afterNode.nodeType == 1) {  // if the node is an element
                                                                        if (["ASIDE", "H2"].includes(afterNode.tagName)) {
                                                                            // skip asides and headings
                                                                            continue;
                                                                        } else if (afterNode.className.includes("entry")) {
                                                                            // don't include anything outside of the entry
                                                                            // also prevents adding " ..." after the text
                                                                            break;
                                                                        }
                                                                    }
																	let match = afterNode.textContent.match(/^[^ ]*(?: [^ ]+){0,25} ?/);
																	if (match !== null) {  // if words could be found
																		afterText += match[0];
																	}
																	if (afterText.length > 80) {  // if the snippet has gotten long enough
																		afterText += " ...";
																		break;
																	}
																}
															}
														} while (afterNode !== null);  // while there are still parent nodes
														info.snippet = beforeText + occurrence.textContent + afterText;
														info.HTML = entry;
														entryList.push(info);
													}
												});
											});
											// display the entries
											S.forEach(entryList, function (entry) {
												let heading = document.createElement("h2");
												heading.innerHTML = "<a href='" + entry.url + "'>" + entry.heading + "</a>";
												S.getId("entryDisplay").appendChild(heading);
												let snippet = document.createElement("section");
												snippet.textContent = entry.snippet;
												S.getId("entryDisplay").appendChild(snippet);
											});
											//// use text fragment linking to link to the location?
										}
									});
								});
							}
						} else if (query[0] == "t") {
							let topic = topics[query[1]];
							if (typeof topic === undefined || topic == {}) {
								S.getId("heading").textContent = "Error";
								S.getId("result").innerHTML = "This topic doesn't exist.";
							} else {
								S.getId("heading").textContent = topic.title;
								addListItem("Summary:", topic.summary);
                                addListItem("Keywords:", topic.keywords.join(", "));
                                addListItem("Topic number: " + query[1]);
                            }

							//// add snippets of text where the topic is found
							//// use text fragment linking to link to the location?
						} else if (query[0] == "hint") {
							let hint = decodeURIComponent(query[1]);
							let results = {};
							// checks for matches with people
							S.forEach(people.slice(1), function (person, index) {
								let personComparison = Math.min(S.compare(person.name, hint) * 1.5, S.compare(person.firstName, hint), S.compare(person.lastName, hint), S.compare(person.firstName + " " + person.lastName, hint), S.compare(person.name + " " + person.lastName, hint));
								if (person.extraNames) {
									person.extraNames.forEach(function (name) {
										personComparison = Math.min(S.compare(name, hint), personComparison);
									});
								}
								if (personComparison <= 3) {
									if (results.hasOwnProperty(personComparison)) {
										results[Math.round(personComparison * 10)].push({ type: "person", item: person, index: index + 1 });
									} else {
										results[Math.round(personComparison * 10)] = [{ type: "person", item: person, index: index + 1 }];
									}
								}
							});
							// checks for matches with topics
							hint = hint.toLowerCase();
							S.forEach(topics.slice(1), function (topic, index) {
								let topicComparison = Math.min(S.compare(topic.title.toLowerCase(), hint), S.compare(topic.summary.toLowerCase(), hint) / 1.5);
								/*
								if (topicComparison <= 4) {
									if (results.hasOwnProperty(topicComparison)) {
										results[Math.round(topicComparison * 10)].push({ type: "topic", item: topic, index: index + 1 });
									} else {
										results[Math.round(topicComparison * 10)] = [{ type: "topic", item: topic, index: index + 1 }];
									}
                                }
								*/
                                if (topic.title.toLowerCase().includes(hint) || topic.summary.includes(hint.toLowerCase())) {
                                    if (results.hasOwnProperty(topicComparison)) {
                                        results[Math.round(topicComparison * 10)].push({ type: "topic", item: topic, index: index + 1 });
                                    } else {
                                        results[Math.round(topicComparison * 10)] = [{ type: "topic", item: topic, index: index + 1 }];
                                    }
                                }
							});
							// displays results
							S.forEach(results, function (set) {
								S.forEach(set, function (result) {
									if (result.type == "person") {
										addListItem('<a href="?p=' + result.index + '">' + result.item.name + "</a><br>(" + result.item.firstName + " " + result.item.lastName + ")");
									} else if (result.type == "topic") {
										addListItem('<a href="?t=' + result.index + '">' + result.item.title + "</a><br>(" + result.item.summary + ")");
									}
								});
							});
							// accounts for no results
							if (S.getId("result").innerHTML == "") {
								S.getId("result").innerHTML = "No result was found.";
							}
						} else {
							S.getId("result").innerHTML = "An invalid type of search was attempted.";
						}
					});
				}
			});

			window.addEventListener("loadedAllPeople", function () {
				S.getId("searchButton").disabled = false;
				S.getId("peopleLister").disabled = false;
			});
		</script>
		<link rel="stylesheet" href="https://epicenterprograms.github.io/standards/formatting/foundation.css">
		<link rel="stylesheet" href="formatting.css">
		<style>
			#result li {
				font-size: 1.25rem;
				font-weight: bold;
			}
		</style>
	</head>
	<body>
		<nav class="hidden-left-nav">
			<iframe src="navigation.html"></iframe>
		</nav>
		<h1 class="main-title" id="pageTitle">
			Search
		</h1>
		<main>
			<input type="text" id="searchText" placeholder="Type something to search">
			<button id="searchButton" disabled>
				Search
			</button>
			<p>
				This will allow you to find things.
			</p>
			<button id="peopleLister" disabled>
				List people
			</button>
			<button id="topicLister">
				List topics
			</button>
			<h2 id="heading">
				Results:
			</h2>
			<table class="labeled-list" id="result"></table>
			<div id="entryDisplay"></div>
		</main>
	</body>
</html>
